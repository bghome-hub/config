# --- <Configuration> ---
$GPC_Server      = "SQLSERVERNAME"      # Your SQL Server Instance
$GPC_Database    = "TWO"                # Your Company Database ID (e.g., TWO, GPCOMPANY)
$GPWS_URL        = "http://GPSERVER:48620/Dynamics/GPService.asmx" # Verify your port (default 48620)
$BatchNumber     = "BATCH_ID_HERE"      # The Batch ID you created via eConnect
$ApprovalComment = "Approved via PowerShell Automation"
# -----------------------

try {
    # 1. FIND THE ACTIVE WORKFLOW TASK ID
    # We must query SQL to find the Task ID linked to this specific Batch Number.
    # WFI10002 = Workflow Instance Master (Links Batch to Workflow)
    # WFI10004 = Workflow Task Master (The actual task awaiting action)
    
    $SqlQuery = @"
    SELECT TOP 1 T.Workflow_Step_Instance_ID
    FROM $GPC_Database..WFI10002 I
    INNER JOIN $GPC_Database..WFI10004 T ON I.Workflow_Instance_ID = T.Workflow_Instance_ID
    WHERE I.Workflow_Business_Obj_Key = '$BatchNumber'
      AND T.Workflow_Step_Status = 1  -- 1 = Pending User Action
    ORDER BY T.DEX_ROW_ID DESC
"@

    # Execute SQL to get the ID
    $TaskID = Invoke-Sqlcmd -ServerInstance $GPC_Server -Query $SqlQuery -TrustServerCertificate
    
    if (-not $TaskID) {
        Write-Error "No pending workflow task found for Batch: $BatchNumber"
        return
    }
    
    $WorkflowStepID = $TaskID.Workflow_Step_Instance_ID
    Write-Host "Found Pending Task ID: $WorkflowStepID" -ForegroundColor Cyan

    # 2. CONNECT TO GP WEB SERVICES
    # Use current windows credentials (run script as the approver)
    $GPService = New-WebServiceProxy -Uri $GPWS_URL -UseDefaultCredential

    # 3. CONSTRUCT THE APPROVAL OBJECTS
    # We need a 'WorkflowTask' object and a 'Completion' action
    
    # Create the key object identifying the task
    $WfStepKey = New-Object Microsoft.PowerShell.Commands.NewWebserviceProxy.AutogeneratedTypes.WebServiceProxy1.WorkflowStepInstanceKey
    $WfStepKey.Id = $WorkflowStepID
    $WfStepKey.CompanyKey = New-Object Microsoft.PowerShell.Commands.NewWebserviceProxy.AutogeneratedTypes.WebServiceProxy1.CompanyKey
    $WfStepKey.CompanyKey.Id = -1 # Context is usually handled by the binding, but strictly -1 or CompanyID often works

    # Create the complete task parameters
    # The Action "1" typically maps to Approve in default GP enumerations, 
    # but we often use the 'CompleteTask' method with specific outcome objects.
    
    # NOTE: The simplest method for Workflow 2.0 is often 'UpdateTask' or 'CompleteTask'
    # depending on your WSDL version. Below is the standard 'CompleteTask' approach.
    
    $CompletionStatus = [Microsoft.PowerShell.Commands.NewWebserviceProxy.AutogeneratedTypes.WebServiceProxy1.WorkflowAction]::Approve
    
    # 4. EXECUTE APPROVAL
    Write-Host "Attempting to approve..."
    
    # The method signature is usually: CompleteTask(Key, Action, Comment)
    $Result = $GPService.CompleteWorkflowTask($WfStepKey, $CompletionStatus, $ApprovalComment)
    
    if ($Result) {
        Write-Host "Success! Batch $BatchNumber has been approved." -ForegroundColor Green
    } else {
        Write-Host "Command sent, but check GP to verify status." -ForegroundColor Yellow
    }

} catch {
    Write-Error "An error occurred: $_"
}
